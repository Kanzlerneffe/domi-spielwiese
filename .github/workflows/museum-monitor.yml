name: Museum Slot Monitor

on:
  schedule:
    - cron: '*/5 * * * *'  # Läuft alle 5 Minuten
  workflow_dispatch:  # Ermöglicht manuelle Ausführung

permissions:
  contents: read
  issues: write

jobs:
  check-museum-slots:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          
      - name: Install dependencies
        run: npm install axios cheerio

      - name: Check for slots
        uses: actions/github-script@v6
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        with:
          script: |
            const axios = require('axios');
            
            async function sendTelegramMessage(message) {
              try {
                const telegramUrl = `https://api.telegram.org/bot${process.env.TELEGRAM_BOT_TOKEN}/sendMessage`;
                await axios.post(telegramUrl, {
                  chat_id: process.env.TELEGRAM_CHAT_ID,
                  text: message,
                  parse_mode: 'HTML'
                });
              } catch (error) {
                console.error('Fehler beim Senden der Telegram-Nachricht:', error);
              }
            }
            
            async function checkSeptemberSlots() {
              try {
                // API-Anfrage für September 2024
                console.log('Prüfe September 2024 Slots...');
                const septemberResponse = await axios.get('https://museum-tickets.nintendo.com/api/calendar/2024-09', {
                  headers: {
                    'Accept': 'application/json',
                    'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36'
                  }
                });
                
                if (!septemberResponse.data || !septemberResponse.data.days) {
                  throw new Error('Unerwartetes API-Antwortformat');
                }
                
                const availableSlots = [];
                Object.entries(septemberResponse.data.days).forEach(([date, dayData]) => {
                  if (dayData.availability && Array.isArray(dayData.availability)) {
                    const availableTimeslots = dayData.availability
                      .filter(slot => slot.available === true)
                      .map(slot => ({
                        time: slot.start_time,
                        remaining: slot.remaining_tickets || 'unbekannt'
                      }));
                      
                    if (availableTimeslots.length > 0) {
                      availableSlots.push({
                        date: date,
                        slots: availableTimeslots
                      });
                    }
                  }
                });
                
                // Wenn Slots verfügbar sind
                if (availableSlots.length > 0) {
                  console.log(`${availableSlots.length} Tage mit freien Slots gefunden!`);
                  
                  const message = availableSlots
                    .map(day => {
                      const slotsInfo = day.slots
                        .map(slot => `⏰ ${slot.time} (${slot.remaining} Tickets)`)
                        .join('\n');
                      return `📅 <b>${day.date}</b>:\n${slotsInfo}`;
                    })
                    .join('\n\n');
                  
                  const fullMessage = `🎮 <b>Freie Slots im Nintendo Museum (September 2024)!</b>\n\n${message}\n\n🔗 Jetzt buchen: https://museum-tickets.nintendo.com/en/calendar`;
                  
                  // Issue erstellen
                  await github.rest.issues.create({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    title: `🎮 ${availableSlots.length} Tag(e) mit freien Slots im September gefunden!`,
                    body: fullMessage.replace(/<\/?b>/g, '**')
                  });
                  
                  // Telegram Nachricht senden
                  await sendTelegramMessage(fullMessage);
                } else {
                  console.log('Keine freien Slots im September gefunden.');
                }
                
              } catch (error) {
                console.error('Fehler beim Überprüfen der Slots:', error);
                const errorMessage = `❌ <b>Fehler beim Überprüfen der Museum-Slots:</b>\n\n${error.message}\n\nDer Bot läuft weiter und prüft beim nächsten Durchlauf erneut.`;
                await sendTelegramMessage(errorMessage);
                core.setFailed(error.message);
              }
            }
            
            await checkSeptemberSlots();
