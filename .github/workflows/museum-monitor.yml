name: Museum Slot Monitor

on:
  schedule:
    - cron: '*/5 * * * *'  # LÃ¤uft alle 5 Minuten
  workflow_dispatch:  # ErmÃ¶glicht manuelle AusfÃ¼hrung

permissions:
  contents: read
  issues: write

jobs:
  check-museum-slots:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          
      - name: Install dependencies
        run: npm install axios cheerio

      - name: Check for slots
        uses: actions/github-script@v6
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        with:
          script: |
            const axios = require('axios');
            
            async function sendTelegramMessage(message) {
              try {
                const telegramUrl = `https://api.telegram.org/bot${process.env.TELEGRAM_BOT_TOKEN}/sendMessage`;
                await axios.post(telegramUrl, {
                  chat_id: process.env.TELEGRAM_CHAT_ID,
                  text: message,
                  parse_mode: 'HTML'
                });
              } catch (error) {
                console.error('Fehler beim Senden der Telegram-Nachricht:', error);
              }
            }
            
            async function checkSeptemberSlots() {
              try {
                console.log('PrÃ¼fe September 2024 Slots...');
                
                // Versuche die Kalenderseite zu laden
                const calendarResponse = await axios.get('https://museum-tickets.nintendo.com/en/calendar', {
                  headers: {
                    'Accept': 'text/html',
                    'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36'
                  }
                });
                
                // Wenn die Kalenderseite lÃ¤dt, versuche September 2024 zu laden
                const septemberUrl = 'https://museum-tickets.nintendo.com/api/calendar/2024-09';
                try {
                  const septemberResponse = await axios.get(septemberUrl, {
                    headers: {
                      'Accept': 'application/json',
                      'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36'
                    }
                  });
                  
                  const septemberData = septemberResponse.data;
                  
                  if (!septemberData || !septemberData.days) {
                    console.log('September 2024 ist noch nicht verfÃ¼gbar.');
                    return;
                  }
                  
                  // Erstelle eine sortierte Liste aller Septembertage
                  const allDays = Object.entries(septemberData.days)
                    .sort(([dateA], [dateB]) => dateA.localeCompare(dateB))
                    .map(([date, dayData]) => {
                      const availableSlots = [];
                      const unavailableSlots = [];
                      
                      if (dayData.availability && Array.isArray(dayData.availability)) {
                        dayData.availability.forEach(slot => {
                          if (slot.available === true) {
                            availableSlots.push({
                              time: slot.start_time,
                              remaining: slot.remaining_tickets || 'unbekannt'
                            });
                          } else {
                            unavailableSlots.push({
                              time: slot.start_time
                            });
                          }
                        });
                      }
                      
                      return {
                        date,
                        availableSlots,
                        unavailableSlots,
                        hasAvailable: availableSlots.length > 0
                      };
                    });
                  
                  // Erstelle die Nachricht
                  let message = `ğŸ® <b>Nintendo Museum Status Update - September 2024</b>\n\n`;
                  
                  // Zuerst die Tage mit verfÃ¼gbaren Slots
                  const availableDays = allDays.filter(day => day.hasAvailable);
                  if (availableDays.length > 0) {
                    message += `âœ… <b>VerfÃ¼gbare Termine:</b>\n`;
                    availableDays.forEach(day => {
                      message += `\nğŸ“… ${day.date}:\n`;
                      day.availableSlots.forEach(slot => {
                        message += `â° ${slot.time} (${slot.remaining} Tickets)\n`;
                      });
                    });
                  }
                  
                  // Dann die Tage ohne verfÃ¼gbare Slots
                  const unavailableDays = allDays.filter(day => !day.hasAvailable);
                  if (unavailableDays.length > 0) {
                    message += `\nâŒ <b>Ausgebuchte Termine:</b>\n`;
                    unavailableDays.forEach(day => {
                      message += `\nğŸ“… ${day.date}:\n`;
                      day.unavailableSlots.forEach(slot => {
                        message += `â° ${slot.time} (ausgebucht)\n`;
                      });
                    });
                  }
                  
                  message += `\nğŸ”— <b>Buchungslink:</b> https://museum-tickets.nintendo.com/en/calendar`;
                  
                  // Sende die Nachricht
                  await sendTelegramMessage(message);
                  
                  // Wenn es verfÃ¼gbare Slots gibt, erstelle auch ein Issue
                  if (availableDays.length > 0) {
                    await github.rest.issues.create({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      title: `ğŸ® ${availableDays.length} Tag(e) mit freien Slots im September 2024 gefunden!`,
                      body: message.replace(/<\/?b>/g, '**')
                    });
                  }
                  
                } catch (error) {
                  if (error.response && error.response.status === 404) {
                    console.log('September 2024 ist noch nicht im System verfÃ¼gbar.');
                    return;
                  }
                  throw error;
                }
                
              } catch (error) {
                console.error('Fehler beim ÃœberprÃ¼fen der Slots:', error);
                if (error.response && error.response.status === 404) {
                  return;
                }
                const errorMessage = `âŒ <b>Fehler beim ÃœberprÃ¼fen der Museum-Slots:</b>\n\n${error.message}\n\nDer Bot lÃ¤uft weiter und prÃ¼ft beim nÃ¤chsten Durchlauf erneut.`;
                await sendTelegramMessage(errorMessage);
                core.setFailed(error.message);
              }
            }
            
            await checkSeptemberSlots();
