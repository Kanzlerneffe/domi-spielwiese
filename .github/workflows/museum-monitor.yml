name: Nintendo Museum Ticket Monitor

on:
  schedule:
    - cron: '*/30 6-22 * * *'  # Alle 30 min zwischen 8:00-24:00 Berlin Zeit
  workflow_dispatch:  # Manueller Start möglich

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: read
  issues: write

jobs:
  check-museum-slots:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Install dependencies
        run: npm install axios cheerio

      - name: Check Nintendo Museum Tickets
        uses: actions/github-script@v7
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        with:
          script: |
            const axios = require('axios');
            
            async function sendTelegramMessage(message) {
              try {
                if (!process.env.TELEGRAM_BOT_TOKEN || !process.env.TELEGRAM_CHAT_ID) {
                  console.log('⚠️ Telegram-Credentials fehlen - sende nur Console-Output');
                  console.log(message);
                  return;
                }
                
                const telegramUrl = `https://api.telegram.org/bot${process.env.TELEGRAM_BOT_TOKEN}/sendMessage`;
                
                await axios.post(telegramUrl, {
                  chat_id: process.env.TELEGRAM_CHAT_ID,
                  text: message,
                  parse_mode: 'HTML',
                  disable_web_page_preview: false
                });
                
                console.log('✅ Telegram-Nachricht gesendet');
              } catch (error) {
                console.error('❌ Telegram-Fehler:', error.message);
                console.log('📝 Nachricht (Fallback):', message);
              }
            }

            function formatDate(dateStr) {
              const [year, month, day] = dateStr.split('-');
              return `${day}.${month}`;
            }

            function getStatusEmoji(dayData) {
              if (!dayData) return '❓';
              
              // Museum geschlossen
              if (dayData.open_status === 2) return '🔒';
              
              // Tickets verfügbar!
              if (dayData.sale_status === 1 && dayData.open_status === 1) return '🎟️';
              
              // Ausverkauft/Nicht verfügbar
              if (dayData.sale_status === 2) return '❌';
              
              return '⚪';
            }

            function getStatusText(dayData) {
              if (!dayData) return 'Status unbekannt';
              
              if (dayData.open_status === 2) return 'Museum geschlossen';
              if (dayData.sale_status === 1 && dayData.open_status === 1) return '🚨 VERFÜGBAR - JETZT SCHNELL! 🚨';
              if (dayData.sale_status === 2) return 'Ausverkauft';
              
              return 'Nicht verfügbar';
            }
            
            async function fetchCalendarData(year, month) {
              try {
                // Korrigierte API-URL basierend auf der Analyse
                const url = `https://museum-tickets.nintendo.com/en/api/calendar?target_year=${year}&target_month=${month}`;
                console.log(`🔍 Lade Kalenderdaten: ${url}`);
                
                const response = await axios.get(url, {
                  headers: {
                    'Accept': 'application/json, text/plain, */*',
                    'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
                    'Referer': 'https://museum-tickets.nintendo.com/en/calendar',
                    'Accept-Language': 'en-US,en;q=0.9'
                  },
                  timeout: 10000
                });
                
                console.log(`✅ API Response Status: ${response.status}`);
                
                if (response.data && response.data.data && response.data.data.calendar) {
                  return response.data.data.calendar;
                } else if (response.data && response.data.calendar) {
                  return response.data.calendar;
                } else {
                  console.log('⚠️ Unerwartetes Datenformat:', JSON.stringify(response.data).substring(0, 200));
                  return null;
                }
                
              } catch (error) {
                console.error('❌ API-Fehler:', {
                  message: error.message,
                  status: error.response?.status,
                  statusText: error.response?.statusText
                });
                return null;
              }
            }
            
            async function checkMuseumSlots() {
              try {
                const now = new Date();
                const currentYear = now.getFullYear();
                const currentMonth = now.getMonth() + 1;
                
                // Prüfe aktuelles Jahr September oder nächstes Jahr
                const targetYear = currentMonth >= 9 ? currentYear + 1 : currentYear;
                
                console.log(`🎮 Prüfe Nintendo Museum September ${targetYear}...`);
                
                const septemberData = await fetchCalendarData(targetYear, 9);
                
                if (!septemberData) {
                  const fallbackMsg = `⚠️ Nintendo Museum API nicht erreichbar oder Datenformat geändert.\n\n🔗 Manuelle Prüfung: https://museum-tickets.nintendo.com/en/calendar`;
                  await sendTelegramMessage(fallbackMsg);
                  return;
                }
                
                const sortedDays = Object.entries(septemberData)
                  .filter(([date]) => date.includes('2025-09-') || date.includes(`${targetYear}-09-`))
                  .sort(([dateA], [dateB]) => dateA.localeCompare(dateB));
                
                if (sortedDays.length === 0) {
                  await sendTelegramMessage(`ℹ️ September ${targetYear} Kalender noch nicht verfügbar.\n\n🔗 Link: https://museum-tickets.nintendo.com/en/calendar`);
                  return;
                }
                
                let message = `🎮 <b>Nintendo Museum Status Update</b>\n`;
                message += `📅 September ${targetYear}\n\n`;
                
                let availableCount = 0;
                let availableDates = [];
                
                sortedDays.forEach(([date, dayData]) => {
                  const formattedDate = formatDate(date);
                  const emoji = getStatusEmoji(dayData);
                  const status = getStatusText(dayData);
                  
                  message += `${emoji} <b>${formattedDate}</b> = ${status}\n`;
                  
                  if (dayData.sale_status === 1 && dayData.open_status === 1) {
                    availableCount++;
                    availableDates.push(formattedDate);
                  }
                });
                
                message += `\n📊 <b>Zusammenfassung:</b>\n`;
                message += `✅ Verfügbare Tage: ${availableCount}\n`;
                
                if (availableCount > 0) {
                  message += `🚨 <b>SCHNELL BUCHEN:</b> ${availableDates.join(', ')}\n`;
                }
                
                message += `\n🔗 <a href="https://museum-tickets.nintendo.com/en/calendar">Zur Buchungsseite</a>`;
                
                await sendTelegramMessage(message);
                
                // GitHub Issue erstellen wenn Tickets verfügbar
                if (availableCount > 0) {
                  console.log('🎯 Erstelle GitHub Issue für verfügbare Tickets');
                  await github.rest.issues.create({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    title: `🎮 Nintendo Museum Tickets verfügbar! (${availableDates.join(', ')})`,
                    body: `**🚨 SOFORT HANDELN! 🚨**\n\n${message.replace(/<[^>]*>/g, '')}\n\n**Verfügbare Termine:** ${availableDates.join(', ')}\n\n[Jetzt buchen!](https://museum-tickets.nintendo.com/en/calendar)`,
                    labels: ['ticket-alert', 'nintendo-museum', 'urgent']
                  });
                }
                
              } catch (error) {
                console.error('💥 Hauptfehler:', error);
                const errorMessage = `❌ <b>Nintendo Museum Monitor Fehler</b>\n\n${error.message}\n\n⏰ Nächste Prüfung in 30 Minuten`;
                await sendTelegramMessage(errorMessage);
                core.setFailed(error.message);
              }
            }
            
            await checkMuseumSlots();
