name: Nintendo Museum Ticket Monitor ğŸ®

on:
  schedule:
    - cron: '*/10 6-22 * * *'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: read
  issues: write

jobs:
  monitor-nintendo-tickets:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Install dependencies
        run: |
          npm install playwright node-fetch
          npx playwright install chromium

      - name: Monitor Nintendo Museum Tickets
        uses: actions/github-script@v7
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        with:
          script: |
            const { chromium } = require('playwright');
            
            async function sendTelegramMessage(message) {
              try {
                console.log('ğŸ“¤ Sending Telegram message...');
                
                const fetch = (await import('node-fetch')).default;
                const response = await fetch(`https://api.telegram.org/bot${process.env.TELEGRAM_BOT_TOKEN}/sendMessage`, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({
                    chat_id: process.env.TELEGRAM_CHAT_ID,
                    text: message,
                    parse_mode: 'HTML'
                  })
                });
                
                if (response.ok) {
                  console.log('âœ… Telegram message sent successfully');
                  return true;
                } else {
                  console.error('âŒ Telegram error:', await response.text());
                  return false;
                }
              } catch (error) {
                console.error('ğŸ’¥ Telegram error:', error.message);
                return false;
              }
            }

            async function checkNintendoMuseum() {
              let browser;
              let statusMessage = '';
              
              try {
                console.log('ğŸ® Starting Nintendo Museum check...');
                
                // Load the main page
                const response = await fetch('https://museum-tickets.nintendo.com/en/calendar');
                
                if (!response.ok) {
                  throw new Error(`Website not accessible: ${response.status}`);
                }
                
                const html = await response.text();
                console.log('ğŸ“„ Page loaded, size:', html.length);
                
                // Parse September calendar data using regex patterns
                const septemberData = {};
                
                // Extract all September dates from the HTML
                // Look for patterns like: gridcell "September X, 2025"
                const septemberPattern = /gridcell "September (\d{1,2}), 2025"[^>]*>([\s\S]*?)(?=gridcell|row|$)/g;
                let match;
                
                while ((match = septemberPattern.exec(html)) !== null) {
                  const day = match[1];
                  const cellContent = match[2];
                  
                  // Determine status based on content
                  let status = 'unknown';
                  
                  if (cellContent.includes('off') || cellContent.includes('closed')) {
                    status = 'closed';
                  } else if (cellContent.includes('cursor:pointer') || cellContent.includes('available')) {
                    status = 'available';
                  } else if (cellContent.includes('sold') || cellContent.includes('full')) {
                    status = 'sold_out';
                  } else {
                    // If no clear indicators, assume sold out for now
                    status = 'sold_out';
                  }
                  
                  septemberData[day] = status;
                }
                
                // Add known closed days (Mondays)
                const closedDays = [2, 9, 16, 23, 30];
                closedDays.forEach(day => {
                  septemberData[day] = 'closed';
                });
                
                // Build status report
                let availableCount = 0;
                let soldOutCount = 0;
                let closedCount = 0;
                let statusLines = [];
                
                for (let day = 1; day <= 30; day++) {
                  const status = septemberData[day] || 'sold_out';
                  const dayStr = day.toString().padStart(2, '0');
                  
                  if (status === 'available') {
                    statusLines.push(`ğŸŸï¸ ${dayStr}.09 = ğŸŸï¸ VerfÃ¼gbar!`);
                    availableCount++;
                  } else if (status === 'closed') {
                    statusLines.push(`ğŸ”’ ${dayStr}.09 = ğŸ”’ Museum geschlossen`);
                    closedCount++;
                  } else {
                    statusLines.push(`âŒ ${dayStr}.09 = âŒ Ausverkauft`);
                    soldOutCount++;
                  }
                }
                
                // Create message
                statusMessage = `ğŸ® <b>Nintendo Museum Status Update</b>
ğŸ“… <b>September 2025</b>
âš¡ Live-Monitoring alle 10 Minuten

${statusLines.join('\n')}

ğŸ“Š <b>Zusammenfassung:</b>
ğŸŸï¸ VerfÃ¼gbar: ${availableCount}
âŒ Ausverkauft: ${soldOutCount}
ğŸ”’ Geschlossen: ${closedCount}

ğŸ”— <a href="https://museum-tickets.nintendo.com/en/calendar">Zur Buchungsseite</a>

â° ${new Date().toLocaleString('de-DE', {timeZone: 'Europe/Berlin'})}
âš¡ NÃ¤chste PrÃ¼fung: in 10 Minuten`;

                // Send immediate alert for available tickets
                if (availableCount > 0) {
                  const alertMessage = `ğŸš¨ <b>NINTENDO MUSEUM TICKETS VERFÃœGBAR!</b> ğŸš¨

ğŸŸï¸ <b>${availableCount} Tag(e) verfÃ¼gbar!</b>

${statusLines.filter(line => line.includes('ğŸŸï¸')).join('\n')}

âš¡ <b>JETZT BUCHEN:</b>
ğŸ”— https://museum-tickets.nintendo.com/en/calendar

â° Gefunden: ${new Date().toLocaleString('de-DE', {timeZone: 'Europe/Berlin'})}`;
                  
                  await sendTelegramMessage(alertMessage);
                }

              } catch (error) {
                console.error('ğŸ’¥ Error during monitoring:', error.message);
                statusMessage = `âŒ <b>Nintendo Museum Monitor Fehler</b>
â° ${new Date().toLocaleString('de-DE', {timeZone: 'Europe/Berlin'})}
ğŸ”§ ${error.message}

ğŸ”„ System versucht es beim nÃ¤chsten Check erneut...
âš¡ NÃ¤chste PrÃ¼fung: in 10 Minuten`;
              } finally {
                if (browser) {
                  await browser.close();
                  console.log('ğŸ”’ Browser closed');
                }
              }
              
              return statusMessage;
            }

            // Main execution
            try {
              console.log('ğŸš€ Starting Nintendo Museum monitoring...');
              const statusMessage = await checkNintendoMuseum();
              
              console.log('ğŸ“¤ Sending status update...');
              const success = await sendTelegramMessage(statusMessage);
              
              if (success) {
                console.log('âœ… Monitoring completed successfully!');
              } else {
                console.error('âŒ Failed to send status update');
              }
              
            } catch (error) {
              console.error('ğŸ’¥ Fatal error:', error.message);
              
              const errorMessage = `âŒ <b>Nintendo Museum Monitor Fehler</b>
â° ${new Date().toLocaleString('de-DE', {timeZone: 'Europe/Berlin'})}
ğŸ”§ Unerwarteter Fehler: ${error.message}`;
              
              await sendTelegramMessage(errorMessage);
            }
