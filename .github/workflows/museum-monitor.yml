name: Museum Slot Monitor

on:
  schedule:
    - cron: '*/15 5-21 * * *'  # Alle 15 min zwischen 7:30-23:30 Berliner Zeit (UTC+2)
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: read
  issues: write

jobs:
  check-museum-slots:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          
      - name: Install dependencies
        run: npm install axios

      - name: Check for slots
        uses: actions/github-script@v6
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        with:
          script: |
            const axios = require('axios');
            
            async function sendTelegramMessage(message) {
              try {
                if (!process.env.TELEGRAM_BOT_TOKEN || !process.env.TELEGRAM_CHAT_ID) {
                  throw new Error('Telegram Credentials fehlen! Bitte TELEGRAM_BOT_TOKEN und TELEGRAM_CHAT_ID in den Repository Secrets konfigurieren.');
                }
                
                const telegramUrl = `https://api.telegram.org/bot${process.env.TELEGRAM_BOT_TOKEN}/sendMessage`;
                console.log('Sende Telegram-Nachricht...');
                
                const response = await axios.post(telegramUrl, {
                  chat_id: process.env.TELEGRAM_CHAT_ID,
                  text: message,
                  parse_mode: 'HTML'
                });
                
                console.log('Telegram-Nachricht erfolgreich gesendet');
                return response.data;
              } catch (error) {
                console.error('Detaillierter Telegram-Fehler:', {
                  message: error.message,
                  response: error.response ? {
                    status: error.response.status,
                    statusText: error.response.statusText,
                    data: error.response.data
                  } : 'Keine Response-Daten',
                  request: {
                    url: telegramUrl,
                    chatId: process.env.TELEGRAM_CHAT_ID ? 'Vorhanden' : 'Fehlt',
                    token: process.env.TELEGRAM_BOT_TOKEN ? 'Vorhanden' : 'Fehlt'
                  }
                });
                throw new Error(`Telegram-Fehler: ${error.message}`);
              }
            }

            function formatDate(dateStr) {
              try {
                const date = new Date(dateStr);
                if (isNaN(date.getTime())) {
                  throw new Error(`Ungültiges Datum: ${dateStr}`);
                }
                return date.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit' });
              } catch (error) {
                console.error(`Fehler beim Formatieren des Datums ${dateStr}:`, error);
                return dateStr;
              }
            }

            function getTicketStatus(dayData) {
              try {
                if (!dayData) {
                  throw new Error('Keine Tagesdaten vorhanden');
                }
                
                console.log('Tages-Daten:', JSON.stringify({
                  open_status: dayData.open_status,
                  sale_status: dayData.sale_status,
                  holiday: dayData.holiday,
                  day_label: dayData.day_label
                }));
                
                if (dayData.open_status === 2) return 'geschlossen';
                if (dayData.sale_status === 1 && dayData.open_status === 1) return 'Tickets kaufbar! 🎉';
                return 'keine Tickets kaufbar';
              } catch (error) {
                console.error('Fehler beim Ermitteln des Ticket-Status:', error);
                return 'Status unbekannt';
              }
            }
            
            async function fetchCalendarData(year, month) {
              try {
                const monthStr = month.toString().padStart(2, '0');
                const url = `https://museum-tickets.nintendo.com/api/calendar/${year}-${monthStr}`;
                console.log(`Versuche Kalenderdaten zu laden für: ${year}-${monthStr}`);
                
                const response = await axios.get(url, {
                  headers: {
                    'Accept': 'application/json',
                    'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36'
                  }
                });
                
                console.log('API Response Status:', response.status);
                
                if (!response.data?.data?.calendar) {
                  console.error('Unerwartetes API-Response-Format:', JSON.stringify(response.data));
                  throw new Error('Ungültiges API-Response-Format');
                }
                
                return response.data.data.calendar;
              } catch (error) {
                console.error('Detaillierter API-Fehler:', {
                  message: error.message,
                  response: error.response ? {
                    status: error.response.status,
                    statusText: error.response.statusText,
                    data: error.response.data
                  } : 'Keine Response-Daten',
                  url: url
                });
                throw new Error(`API-Fehler: ${error.message}`);
              }
            }
            
            async function checkSlots() {
              try {
                const now = new Date();
                const currentYear = now.getFullYear();
                const currentMonth = now.getMonth() + 1;
                const targetYear = currentMonth >= 9 ? currentYear + 1 : currentYear;
                
                console.log(`Prüfe September ${targetYear}...`);
                
                const septemberData = await fetchCalendarData(targetYear, 9);
                
                if (!septemberData || Object.keys(septemberData).length === 0) {
                  await sendTelegramMessage(`ℹ️ Keine Daten für September ${targetYear} verfügbar. Der Kalender wurde noch nicht freigegeben.`);
                  return;
                }
                
                let message = `🎮 Nintendo Museum Status Update\n\n`;
                
                const sortedDays = Object.entries(septemberData)
                  .sort(([dateA], [dateB]) => dateA.localeCompare(dateB));
                
                let ticketsAvailable = false;
                
                sortedDays.forEach(([date, dayData]) => {
                  const formattedDate = formatDate(date);
                  const status = getTicketStatus(dayData);
                  message += `${formattedDate}: ${status}\n`;
                  
                  if (dayData.sale_status === 1 && dayData.open_status === 1) {
                    ticketsAvailable = true;
                    console.log(`Tickets verfügbar für: ${date}`);
                  }
                });
                
                message += `\n🔗 Buchungslink: https://museum-tickets.nintendo.com/en/calendar`;
                
                await sendTelegramMessage(message);
                
                if (ticketsAvailable) {
                  console.log('Erstelle GitHub Issue für verfügbare Tickets');
                  await github.rest.issues.create({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    title: `🎮 Tickets für September ${targetYear} verfügbar!`,
                    body: message
                  });
                }
                
              } catch (error) {
                console.error('Fehler beim Überprüfen der Slots:', error);
                const errorMessage = `❌ Fehler beim Überprüfen der Museum-Slots:\n\n${error.message}\n\nDer Bot läuft weiter und prüft beim nächsten Durchlauf erneut.`;
                await sendTelegramMessage(errorMessage);
                core.setFailed(error.message);
              }
            }
            
            await checkSlots();
