name: Nintendo Museum Ticket Monitor

on:
  schedule:
    - cron: '*/30 6-22 * * *'  # Alle 30 min zwischen 8:00-24:00 Berlin Zeit
  workflow_dispatch:  # Manueller Start mÃ¶glich

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: read
  issues: write

jobs:
  check-museum-slots:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Install dependencies
        run: npm install axios cheerio

      - name: Check Nintendo Museum Tickets
        uses: actions/github-script@v7
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        with:
          script: |
            const axios = require('axios');
            
            async function sendTelegramMessage(message) {
              try {
                if (!process.env.TELEGRAM_BOT_TOKEN || !process.env.TELEGRAM_CHAT_ID) {
                  console.log('âš ï¸ Telegram-Credentials fehlen - sende nur Console-Output');
                  console.log(message);
                  return;
                }
                
                const telegramUrl = `https://api.telegram.org/bot${process.env.TELEGRAM_BOT_TOKEN}/sendMessage`;
                
                await axios.post(telegramUrl, {
                  chat_id: process.env.TELEGRAM_CHAT_ID,
                  text: message,
                  parse_mode: 'HTML',
                  disable_web_page_preview: false
                });
                
                console.log('âœ… Telegram-Nachricht gesendet');
              } catch (error) {
                console.error('âŒ Telegram-Fehler:', error.message);
                console.log('ğŸ“ Nachricht (Fallback):', message);
              }
            }

            function formatDate(dateStr) {
              const [year, month, day] = dateStr.split('-');
              return `${day}.${month}`;
            }

            function getStatusEmoji(dayData) {
              if (!dayData) return 'â“';
              
              // Museum geschlossen
              if (dayData.open_status === 2) return 'ğŸ”’';
              
              // Tickets verfÃ¼gbar!
              if (dayData.sale_status === 1 && dayData.open_status === 1) return 'ğŸŸï¸';
              
              // Ausverkauft/Nicht verfÃ¼gbar
              if (dayData.sale_status === 2) return 'âŒ';
              
              return 'âšª';
            }

            function getStatusText(dayData) {
              if (!dayData) return 'Status unbekannt';
              
              if (dayData.open_status === 2) return 'Museum geschlossen';
              if (dayData.sale_status === 1 && dayData.open_status === 1) return 'ğŸš¨ VERFÃœGBAR - JETZT SCHNELL! ğŸš¨';
              if (dayData.sale_status === 2) return 'Ausverkauft';
              
              return 'Nicht verfÃ¼gbar';
            }
            
            async function fetchCalendarData(year, month) {
              try {
                // Korrigierte API-URL basierend auf der Analyse
                const url = `https://museum-tickets.nintendo.com/en/api/calendar?target_year=${year}&target_month=${month}`;
                console.log(`ğŸ” Lade Kalenderdaten: ${url}`);
                
                const response = await axios.get(url, {
                  headers: {
                    'Accept': 'application/json, text/plain, */*',
                    'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
                    'Referer': 'https://museum-tickets.nintendo.com/en/calendar',
                    'Accept-Language': 'en-US,en;q=0.9'
                  },
                  timeout: 10000
                });
                
                console.log(`âœ… API Response Status: ${response.status}`);
                
                if (response.data && response.data.data && response.data.data.calendar) {
                  return response.data.data.calendar;
                } else if (response.data && response.data.calendar) {
                  return response.data.calendar;
                } else {
                  console.log('âš ï¸ Unerwartetes Datenformat:', JSON.stringify(response.data).substring(0, 200));
                  return null;
                }
                
              } catch (error) {
                console.error('âŒ API-Fehler:', {
                  message: error.message,
                  status: error.response?.status,
                  statusText: error.response?.statusText
                });
                return null;
              }
            }
            
            async function checkMuseumSlots() {
              try {
                const now = new Date();
                const currentYear = now.getFullYear();
                const currentMonth = now.getMonth() + 1;
                
                // PrÃ¼fe aktuelles Jahr September oder nÃ¤chstes Jahr
                const targetYear = currentMonth >= 9 ? currentYear + 1 : currentYear;
                
                console.log(`ğŸ® PrÃ¼fe Nintendo Museum September ${targetYear}...`);
                
                const septemberData = await fetchCalendarData(targetYear, 9);
                
                if (!septemberData) {
                  const fallbackMsg = `âš ï¸ Nintendo Museum API nicht erreichbar oder Datenformat geÃ¤ndert.\n\nğŸ”— Manuelle PrÃ¼fung: https://museum-tickets.nintendo.com/en/calendar`;
                  await sendTelegramMessage(fallbackMsg);
                  return;
                }
                
                const sortedDays = Object.entries(septemberData)
                  .filter(([date]) => date.includes('2025-09-') || date.includes(`${targetYear}-09-`))
                  .sort(([dateA], [dateB]) => dateA.localeCompare(dateB));
                
                if (sortedDays.length === 0) {
                  await sendTelegramMessage(`â„¹ï¸ September ${targetYear} Kalender noch nicht verfÃ¼gbar.\n\nğŸ”— Link: https://museum-tickets.nintendo.com/en/calendar`);
                  return;
                }
                
                let message = `ğŸ® <b>Nintendo Museum Status Update</b>\n`;
                message += `ğŸ“… September ${targetYear}\n\n`;
                
                let availableCount = 0;
                let availableDates = [];
                
                sortedDays.forEach(([date, dayData]) => {
                  const formattedDate = formatDate(date);
                  const emoji = getStatusEmoji(dayData);
                  const status = getStatusText(dayData);
                  
                  message += `${emoji} <b>${formattedDate}</b> = ${status}\n`;
                  
                  if (dayData.sale_status === 1 && dayData.open_status === 1) {
                    availableCount++;
                    availableDates.push(formattedDate);
                  }
                });
                
                message += `\nğŸ“Š <b>Zusammenfassung:</b>\n`;
                message += `âœ… VerfÃ¼gbare Tage: ${availableCount}\n`;
                
                if (availableCount > 0) {
                  message += `ğŸš¨ <b>SCHNELL BUCHEN:</b> ${availableDates.join(', ')}\n`;
                }
                
                message += `\nğŸ”— <a href="https://museum-tickets.nintendo.com/en/calendar">Zur Buchungsseite</a>`;
                
                await sendTelegramMessage(message);
                
                // GitHub Issue erstellen wenn Tickets verfÃ¼gbar
                if (availableCount > 0) {
                  console.log('ğŸ¯ Erstelle GitHub Issue fÃ¼r verfÃ¼gbare Tickets');
                  await github.rest.issues.create({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    title: `ğŸ® Nintendo Museum Tickets verfÃ¼gbar! (${availableDates.join(', ')})`,
                    body: `**ğŸš¨ SOFORT HANDELN! ğŸš¨**\n\n${message.replace(/<[^>]*>/g, '')}\n\n**VerfÃ¼gbare Termine:** ${availableDates.join(', ')}\n\n[Jetzt buchen!](https://museum-tickets.nintendo.com/en/calendar)`,
                    labels: ['ticket-alert', 'nintendo-museum', 'urgent']
                  });
                }
                
              } catch (error) {
                console.error('ğŸ’¥ Hauptfehler:', error);
                const errorMessage = `âŒ <b>Nintendo Museum Monitor Fehler</b>\n\n${error.message}\n\nâ° NÃ¤chste PrÃ¼fung in 30 Minuten`;
                await sendTelegramMessage(errorMessage);
                core.setFailed(error.message);
              }
            }
            
            await checkMuseumSlots();
