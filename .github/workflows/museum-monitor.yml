name: Nintendo Museum Ticket Monitor ğŸ®

on:
  schedule:
    - cron: '*/10 6-22 * * *'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: read

jobs:
  monitor-nintendo-tickets:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install node-fetch
        run: npm install node-fetch
        
      - name: Monitor Nintendo Museum Tickets
        uses: actions/github-script@v7
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        with:
          script: |
            console.log('ğŸ® Starting Nintendo Museum monitoring...');
            
            // Verwende die EXAKT GLEICHE Telegram-Methode wie im Test!
            async function sendTelegramMessage(message) {
              try {
                const fetch = (await import('node-fetch')).default;
                console.log('ğŸ“¤ Sending message to chat ID:', process.env.TELEGRAM_CHAT_ID);
                
                const response = await fetch(`https://api.telegram.org/bot${process.env.TELEGRAM_BOT_TOKEN}/sendMessage`, {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json'
                  },
                  body: JSON.stringify({
                    chat_id: process.env.TELEGRAM_CHAT_ID,
                    text: message,
                    parse_mode: 'HTML'
                  })
                });
                
                const responseText = await response.text();
                console.log('Response Status:', response.status);
                console.log('Response Body:', responseText);
                
                if (response.ok) {
                  const result = JSON.parse(responseText);
                  if (result.ok) {
                    console.log('âœ… SUCCESS! Message sent successfully!');
                    return true;
                  } else {
                    console.error('âŒ Telegram API error:', result.description);
                    return false;
                  }
                } else {
                  console.error('âŒ Failed to send message:', responseText);
                  return false;
                }
              } catch (error) {
                console.error('ğŸ’¥ Error sending message:', error.message);
                return false;
              }
            }
            
            // Nintendo Museum Check (SUPER EINFACH erstmal)
            try {
              console.log('ğŸ” Checking Nintendo Museum status...');
              
              const fetch = (await import('node-fetch')).default;
              const response = await fetch('https://museum-tickets.nintendo.com/en/calendar');
              
              let statusMessage = '';
              
              if (response.ok) {
                const html = await response.text();
                console.log('ğŸ“„ Page loaded successfully, size:', html.length);
                
                // Einfache Check-Logik fÃ¼r jetzt
                const currentTime = new Date().toLocaleString('de-DE', {timeZone: 'Europe/Berlin'});
                
                statusMessage = `ğŸ® <b>Nintendo Museum Status Update</b>
                
ğŸ“… <b>September 2025</b>
âš¡ Live-Monitoring alle 10 Minuten

ğŸ” <b>Status-Check:</b>
âœ… Website erreichbar
ğŸ“„ Seite geladen (${Math.round(html.length/1000)}KB)
â° GeprÃ¼ft: ${currentTime}

ğŸ¯ <b>NÃ¤chste Funktionen:</b>
â€¢ VerfÃ¼gbarkeits-Erkennung wird implementiert
â€¢ Basierend auf deiner API-Analyse: sale_status: 1 = verfÃ¼gbar

ğŸ”— <a href="https://museum-tickets.nintendo.com/en/calendar">Zur Buchungsseite</a>

âš¡ NÃ¤chste PrÃ¼fung: in 10 Minuten`;

              } else {
                statusMessage = `âŒ <b>Nintendo Museum Monitor Fehler</b>
                
â° ${new Date().toLocaleString('de-DE', {timeZone: 'Europe/Berlin'})}
ğŸ”§ Website nicht erreichbar (Status: ${response.status})
ğŸ”„ Versuche es beim nÃ¤chsten Check erneut...

âš¡ NÃ¤chste PrÃ¼fung: in 10 Minuten`;
              }
              
              // Nachricht senden mit bewÃ¤hrter Methode
              const success = await sendTelegramMessage(statusMessage);
              
              if (success) {
                console.log('ğŸ‰ Monitor update sent successfully!');
              } else {
                console.error('âŒ Failed to send monitor update');
              }
              
            } catch (error) {
              console.error('ğŸ’¥ Monitor error:', error.message);
              
              // Fehler-Nachricht senden
              const errorMessage = `âŒ <b>Nintendo Museum Monitor Fehler</b>
              
â° ${new Date().toLocaleString('de-DE', {timeZone: 'Europe/Berlin'})}
ğŸ”§ ${error.message}
ğŸ”„ System wird beim nÃ¤chsten Check neu versuchen...`;
              
              await sendTelegramMessage(errorMessage);
            }
