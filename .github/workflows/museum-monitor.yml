name: Nintendo Museum Ticket Monitor ğŸ®

on:
  schedule:
    - cron: '*/10 6-22 * * *'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: read
  issues: write

jobs:
  monitor-nintendo-tickets:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Monitor Nintendo Museum Tickets
        uses: actions/github-script@v7
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        with:
          script: |
            async function sendTelegramMessage(message) {
              try {
                const response = await fetch(`https://api.telegram.org/bot${process.env.TELEGRAM_BOT_TOKEN}/sendMessage`, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({
                    chat_id: process.env.TELEGRAM_CHAT_ID,
                    text: message,
                    parse_mode: 'HTML'
                  })
                });
                
                if (response.ok) {
                  console.log('âœ… Telegram message sent successfully');
                  return true;
                } else {
                  console.error('âŒ Telegram error:', await response.text());
                  return false;
                }
              } catch (error) {
                console.error('ğŸ’¥ Telegram error:', error.message);
                return false;
              }
            }

            async function checkNintendoMuseum() {
              try {
                console.log('ğŸ® Starting Nintendo Museum check...');
                
                const response = await fetch('https://museum-tickets.nintendo.com/en/calendar');
                
                if (!response.ok) {
                  throw new Error(`Website not accessible: ${response.status}`);
                }
                
                const html = await response.text();
                console.log('ğŸ“„ Page loaded, size:', html.length);
                
                // Parse September calendar data using the REAL DOM patterns
                const septemberData = {};
                
                // Extract September dates using DOM patterns from my analysis
                const septemberDays = [1,3,4,5,6,7,8,10,11,12,13,14,15,17,18,19,20,21,22,24,25,26,27,28,29];
                const closedDays = [2,9,16,23,30]; // Known closed Mondays
                
                septemberDays.forEach(day => {
                  const dayStr = String(day).padStart(2, '0');
                  
                  // Look for cursor=pointer pattern (available tickets)
                  const availablePattern = new RegExp(`gridcell "September ${day}, 2025"[^>]*\\[cursor=pointer\\]`, 'i');
                  
                  // Look for "off" pattern (museum closed)  
                  const closedPattern = new RegExp(`September ${day}, 2025[\\s\\S]*?generic:\\s*"off"`, 'i');
                  
                  if (availablePattern.test(html)) {
                    septemberData[`09-${dayStr}`] = 'available';
                  } else if (closedPattern.test(html) || closedDays.includes(day)) {
                    septemberData[`09-${dayStr}`] = 'closed';
                  } else {
                    septemberData[`09-${dayStr}`] = 'sold_out';
                  }
                });
                
                console.log('ğŸ“… September analysis complete:', Object.keys(septemberData).length, 'days processed');
                
                // Generate status message
                let statusMessage = `ğŸ® <b>Nintendo Museum Status Update</b>\n`;
                statusMessage += `ğŸ“… <b>September 2025</b>\n`;
                statusMessage += `âš¡ <b>Live-Monitoring alle 10 Minuten</b>\n\n`;
                
                let availableCount = 0;
                let soldOutCount = 0;
                let closedCount = 0;
                let availableDates = [];
                
                // Process all September days in order
                for (let day = 1; day <= 30; day++) {
                  const dayStr = String(day).padStart(2, '0');
                  const dateKey = `09-${dayStr}`;
                  const status = septemberData[dateKey];
                  
                  let statusIcon = '';
                  let statusText = '';
                  
                  if (status === 'available') {
                    statusIcon = 'ğŸŸï¸';
                    statusText = 'ğŸŸï¸ VERFÃœGBAR!';
                    availableCount++;
                    availableDates.push(`${dayStr}.09`);
                  } else if (status === 'closed') {
                    statusIcon = 'ğŸ”’';
                    statusText = 'ğŸ”’ Museum geschlossen';
                    closedCount++;
                  } else {
                    statusIcon = 'âŒ';
                    statusText = 'âŒ Ausverkauft';
                    soldOutCount++;
                  }
                  
                  statusMessage += `${statusIcon} ${dayStr}.09 = ${statusText}\n`;
                }
                
                // Summary
                statusMessage += `\nğŸ“Š <b>Zusammenfassung:</b>\n`;
                statusMessage += `ğŸŸï¸ VerfÃ¼gbar: ${availableCount}\n`;
                statusMessage += `âŒ Ausverkauft: ${soldOutCount}\n`;
                statusMessage += `ğŸ”’ Geschlossen: ${closedCount}\n`;
                
                if (availableCount > 0) {
                  statusMessage += `\nğŸš¨ <b>ALERT: TICKETS VERFÃœGBAR!</b>\n`;
                  statusMessage += `ğŸ“ VerfÃ¼gbare Termine: ${availableDates.join(', ')}\n`;
                  statusMessage += `ğŸ”— <a href="https://museum-tickets.nintendo.com/en/calendar">Sofort buchen!</a>\n`;
                  
                  // Create GitHub issue for available tickets
                  try {
                    await github.rest.issues.create({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      title: `ğŸ® Nintendo Museum Tickets verfÃ¼gbar! ${availableDates.join(', ')}`,
                      body: `VerfÃ¼gbare Termine gefunden:\n${availableDates.map(date => `- ${date}`).join('\n')}\n\nLink: https://museum-tickets.nintendo.com/en/calendar`,
                      labels: ['ticket-alert', 'nintendo-museum']
                    });
                    console.log('ğŸ“ GitHub issue created for available tickets');
                  } catch (issueError) {
                    console.error('âŒ Failed to create GitHub issue:', issueError);
                  }
                } else {
                  statusMessage += `\nğŸ”— <a href="https://museum-tickets.nintendo.com/en/calendar">Zur Buchungsseite</a>\n`;
                }
                
                const now = new Date();
                const berlinTime = new Intl.DateTimeFormat('de-DE', {
                  timeZone: 'Europe/Berlin',
                  day: '2-digit',
                  month: '2-digit', 
                  year: 'numeric',
                  hour: '2-digit',
                  minute: '2-digit',
                  second: '2-digit'
                }).format(now);
                
                statusMessage += `\nğŸ• ${berlinTime}\n`;
                statusMessage += `âš¡ NÃ¤chste PrÃ¼fung: in 10 Minuten`;
                
                // Send Telegram message
                console.log('ğŸ“¤ Sending status update...');
                const sent = await sendTelegramMessage(statusMessage);
                
                if (sent) {
                  console.log('âœ… Status update sent successfully');
                } else {
                  console.error('âŒ Failed to send status update');
                }
                
                return {
                  available: availableCount,
                  sold_out: soldOutCount,
                  closed: closedCount,
                  message_sent: sent
                };
                
              } catch (error) {
                console.error('ğŸ’¥ Error during monitoring:', error.message);
                
                const errorMessage = `âŒ <b>Nintendo Museum Monitor Fehler</b>\nğŸ• ${new Date().toLocaleString('de-DE', {timeZone: 'Europe/Berlin'})}\nğŸ”§ ${error.message}\nğŸ’¡ System wird beim nÃ¤chsten Lauf erneut versuchen...`;
                
                await sendTelegramMessage(errorMessage);
                throw error;
              }
            }

            // Run the monitor
            const result = await checkNintendoMuseum();
            console.log('ğŸ¯ Monitoring result:', result);
