name: Nintendo Museum Ticket Monitor ğŸ®

on:
  schedule:
    - cron: '*/10 6-22 * * *'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: read
  issues: write

jobs:
  monitor-nintendo-tickets:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Install dependencies
        run: |
          npm install node-fetch

      - name: Monitor Nintendo Museum Tickets
        uses: actions/github-script@v7
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        with:
          script: |
            // ğŸ“¡ Telegram Message Function (ORIGINAL mit fetch)
            async function sendTelegramMessage(message) {
              try {
                const fetch = (await import('node-fetch')).default;
                const response = await fetch(`https://api.telegram.org/bot${process.env.TELEGRAM_BOT_TOKEN}/sendMessage`, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({
                    chat_id: process.env.TELEGRAM_CHAT_ID,
                    text: message,
                    parse_mode: 'HTML'
                  })
                });
                
                if (response.ok) {
                  console.log('âœ… Telegram message sent successfully');
                  return true;
                } else {
                  console.error('âŒ Telegram error:', await response.text());
                  return false;
                }
              } catch (error) {
                console.error('ğŸ’¥ Telegram error:', error.message);
                return false;
              }
            }

            async function checkNintendoMuseum() {
              try {
                console.log('ğŸ® Starting Nintendo Museum check...');
                
                // Load the main page (ORIGINAL einfache Methode)
                const fetch = (await import('node-fetch')).default;
                const response = await fetch('https://museum-tickets.nintendo.com/en/calendar');
                
                if (!response.ok) {
                  throw new Error(`Website not accessible: ${response.status}`);
                }
                
                const html = await response.text();
                console.log('ğŸ“„ Page loaded, size:', html.length);
                
                // Parse September calendar data using regex patterns (ORIGINAL)
                const septemberData = {};
                
                // Extract all September dates from the HTML
                // Look for patterns like: gridcell "September X, 2025"
                const septemberPattern = /gridcell "September (\d{1,2}), 2025"[^>]*>([\s\S]*?)(?=gridcell|row|$)/g;
                let match;
                
                while ((match = septemberPattern.exec(html)) !== null) {
                  const day = match[1];
                  const cellContent = match[2];
                  
                  // Check for status indicators in the cell content
                  const hasOff = cellContent.includes('"off"') || 
                               cellContent.includes('off') ||
                               cellContent.includes('Closure');
                  
                  const hasPointer = cellContent.includes('cursor=pointer') ||
                                   cellContent.includes('[cursor=pointer]') ||
                                   cellContent.includes('pointer');
                  
                  const isClickable = hasPointer && !hasOff;
                  
                  const formattedDate = `${day.padStart(2, '0')}.09`;
                  
                  let status;
                  if (hasOff) {
                    status = 'ğŸ”’ Museum geschlossen';
                  } else if (isClickable) {
                    status = 'ğŸŸï¸ VERFÃœGBAR - JETZT SCHNELL!';
                  } else {
                    status = 'âŒ Ausverkauft';
                  }
                  
                  septemberData[formattedDate] = {
                    day: day,
                    status: status,
                    available: isClickable,
                    closed: hasOff
                  };
                }
                
                // If regex parsing fails, use text-based analysis (ORIGINAL Fallback)
                if (Object.keys(septemberData).length === 0) {
                  console.log('ğŸ“ Using fallback text analysis...');
                  
                  // Known closed days (Mondays in September 2025)
                  const closedDays = ['02', '09', '16', '23', '30'];
                  
                  // Generate all September days
                  for (let day = 1; day <= 30; day++) {
                    const dayStr = day.toString().padStart(2, '0');
                    const formattedDate = `${dayStr}.09`;
                    
                    if (closedDays.includes(dayStr)) {
                      septemberData[formattedDate] = {
                        day: dayStr,
                        status: 'ğŸ”’ Museum geschlossen',
                        available: false,
                        closed: true
                      };
                    } else {
                      // Check if the HTML contains availability indicators
                      const hasAvailableIndicators = html.includes('Available now') && 
                                                   html.includes('September');
                      const hasCursorPointer = html.includes('cursor=pointer');
                      
                      // For now, assume sold out unless we find specific availability
                      septemberData[formattedDate] = {
                        day: dayStr,
                        status: 'âŒ Ausverkauft',
                        available: false,
                        closed: false
                      };
                    }
                  }
                }
                
                console.log('ğŸ“Š Found September dates:', Object.keys(septemberData).length);
                
                // Build comprehensive status message (ORIGINAL Format)
                let message = 'ğŸ® <b>Nintendo Museum Status Update</b>\n';
                message += 'ğŸ“… <b>September 2025</b>\n';
                message += 'âš¡ <i>Live-Monitoring alle 10 Minuten</i>\n\n';
                
                let availableCount = 0;
                let availableDates = [];
                let closedCount = 0;
                let soldOutCount = 0;
                
                // Sort dates and build detailed status
                const sortedDates = Object.keys(septemberData).sort();
                
                sortedDates.forEach(date => {
                  const data = septemberData[date];
                  const emoji = data.available ? 'ğŸŸï¸' : (data.closed ? 'ğŸ”’' : 'âŒ');
                  message += `${emoji} ${date} = ${data.status}\n`;
                  
                  if (data.available) {
                    availableCount++;
                    availableDates.push(date);
                  } else if (data.closed) {
                    closedCount++;
                  } else {
                    soldOutCount++;
                  }
                });
                
                message += `\nğŸ“Š <b>Zusammenfassung:</b>\n`;
                message += `ğŸŸï¸ VerfÃ¼gbar: <b>${availableCount}</b>\n`;
                message += `âŒ Ausverkauft: <b>${soldOutCount}</b>\n`;
                message += `ğŸ”’ Geschlossen: <b>${closedCount}</b>\n`;
                
                if (availableCount > 0) {
                  message += `\nğŸš¨ <b>SOFORT BUCHEN:</b> ${availableDates.join(', ')}\n`;
                  message += `ğŸƒâ€â™‚ï¸ <b>Tickets kÃ¶nnen schnell weg sein!</b>\n`;
                }
                
                message += `\nğŸ”— <a href="https://museum-tickets.nintendo.com/en/calendar">Zur Buchungsseite</a>\n\n`;
                message += `â° ${new Date().toLocaleString('de-DE', {timeZone: 'Europe/Berlin'})}\n`;
                message += `âš¡ <i>NÃ¤chste PrÃ¼fung: in 10 Minuten</i>`;
                
                // ALWAYS send status update (every 10 minutes)
                console.log('ğŸ“± Sending status update...');
                const messageSent = await sendTelegramMessage(message);
                
                if (!messageSent) {
                  console.error('âŒ Failed to send Telegram message');
                }
                
                // Create GitHub issue if tickets are available
                if (availableCount > 0) {
                  console.log('ğŸ¯ Creating GitHub issue for available tickets...');
                  
                  const issueTitle = `ğŸš¨ Nintendo Museum Tickets verfÃ¼gbar! (${availableDates.join(', ')})`;
                  const issueBody = `**ğŸš¨ SOFORT HANDELN! ğŸš¨**\n\n${message.replace(/<[^>]*>/g, '')}\n\n**VerfÃ¼gbare Termine:** ${availableDates.join(', ')}\n\n[JETZT BUCHEN!](https://museum-tickets.nintendo.com/en/calendar)\n\n---\nâš¡ **Live-Monitoring aktiv** - alle 10 Minuten\nğŸ“± **Telegram-Alerts** - sofortige Benachrichtigung`;
                  
                  await github.rest.issues.create({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    title: issueTitle,
                    body: issueBody,
                    labels: ['nintendo-museum', 'tickets-available', 'urgent']
                  });
                  
                  console.log('âœ… GitHub issue created successfully');
                }
                
                return messageSent;
                
              } catch (error) {
                console.error('ğŸ’¥ Error during monitoring:', error);
                
                const errorMessage = `âŒ <b>Nintendo Museum Monitor Fehler</b>\n\n<code>${error.message}</code>\n\nâ° ${new Date().toLocaleString('de-DE', {timeZone: 'Europe/Berlin'})}\nğŸ”§ NÃ¤chste PrÃ¼fung in 10 Minuten`;
                
                await sendTelegramMessage(errorMessage);
                return false;
              }
            }
            
            const result = await checkNintendoMuseum();
            console.log('Final result:', result ? 'SUCCESS' : 'FAILED');
